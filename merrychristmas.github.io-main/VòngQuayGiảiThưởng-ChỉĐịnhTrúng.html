<html>
    <head>
        <title>HTML5 Canvas Winning Wheel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="main.css" type="text/css" />
        <link type="icon/x-icon" href="favicon.ico" rel="shortcut icon" />
        <script type="text/javascript" src="Winwheel.min.js"></script>
        <script src="TweenMax.min.js"></script>
    </head>
    <body>
        <div align="center">
            <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td>
                        <button id="spin_start" class="btn" onClick="startSpin();">Quay ngay</button> <br><br>
                        <button id="spin_reset" class="btn" onClick="resetWheel();">Quay l·∫°i</button>
                    </td>
                    <td width="438" height="582" class="the_wheel" align="center" valign="center">
                        <canvas id="canvas" width="434" height="434">
                            <p style="{color: white}" align="center">Sorry, your browser doesn't support canvas. Please try another.</p>
                        </canvas>
                    </td>
                </tr>
            </table>
        </div>
        <script>
            //Th√¥ng s·ªë v√≤ng quay
            let duration = 4; //Th·ªùi gian k·∫øt th√∫c v√≤ng quay
            let spins    = 15; //Quay nhanh hay ch·∫≠m 3, 8, 15
            let theWheel = new Winwheel({
                'numSegments'  : 17,     // Chia 8 ph·∫ßn b·∫±ng nhau
                'outerRadius'  : 212,   // ƒê·∫∑t b√°n k√≠nh v√≤ng quay
                'textFontSize' : 18,    // ƒê·∫∑t k√≠ch th∆∞·ªõc ch·ªØ
                'rotationAngle': 0,     // ƒê·∫∑t g√≥c v√≤ng quay t·ª´ 0 ƒë·∫øn 360 ƒë·ªô.
                'segments'     :        // C√°c th√†nh ph·∫ßn bao g·ªìm m√†u s·∫Øc v√† vƒÉn b·∫£n.
                [
                    {'fillStyle' : '#eae56f', 'text' : 'H√† An'},
                   {'fillStyle' : '#89f26e', 'text' : ' Minh Anh'},
                   {'fillStyle' : '#7de6ef', 'text' : ' V√¢n Anh'},
                   {'fillStyle' : '#e7706f', 'text' : ' H∆∞∆°ng Giang'},
                   {'fillStyle' : '#eae56f', 'text' : ' Ng·ªçc H√¢n'},
                   {'fillStyle' : '#89f26e', 'text' : ' Minh H·∫±ng'},
                   {'fillStyle' : '#7de6ef', 'text' : ' Ph∆∞∆°ng Ho√†ng'},
                   {'fillStyle' : '#e7706f', 'text' : ' H·∫£i Huy·ªÅn'},
                   {'fillStyle' : '#eae56f', 'text' : ' Ng·ªçc Linh'},
                   {'fillStyle' : '#89f26e', 'text' : 'Ng·ªçc Huy·ªÅn'},
                   {'fillStyle' : '#7de6ef', 'text' : ' Ph∆∞∆°ng Linh'},
                   {'fillStyle' : '#e7706f', 'text' : 'Thanh Ng√¢n'},
                   {'fillStyle' : '#eae56f', 'text' : ' Th·∫£o Nguy√™n'},
                   {'fillStyle' : '#89f26e', 'text' : 'Thanh Nh√†n'},
                   {'fillStyle' : '#7de6ef', 'text' : 'T√¢m T√¢m'},
                   {'fillStyle' : '#e7706f', 'text' : 'Thanh Th·∫£o'},
                    {'fillStyle' : '#7de6ef', 'text' : ' Thanh Tr√∫c'},
                ],
                'animation' : {
                    'type'     : 'spinToStop',
                    'duration' : duration,
                    'spins'    : spins,
                    'callbackSound'    : playSound,     //H√†m g·ªçi √¢m thanh khi quay
                    'soundTrigger'     : 'pin',         //Ch·ªâ ƒë·ªãnh ch√¢n l√† ƒë·ªÉ k√≠ch ho·∫°t √¢m thanh
                    'callbackFinished' : alertPrize,    //H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ tr√∫ng gi·∫£i th∆∞·ªüng
                },
                'pins' :
                {
                    'number' : 40   //S·ªë l∆∞·ª£ng ch√¢n. Chia ƒë·ªÅu xung quanh v√≤ng quay.
                }
            });
            
            //Ki·ªÉm tra v√≤ng quay
            let wheelSpinning = false;
            // Ch·ªâ ƒë·ªãnh 3 t√™n mu·ªën quay ra tr∆∞·ªõc (n·∫øu kh√¥ng mu·ªën th√¨ ƒë·ªÉ r·ªóng: [])
            // V√≠ d·ª•: let forcedWinners = ['H√† An', ' Minh Anh', ' V√¢n Anh'];
            let forcedWinners = [' Minh Anh', ' Ng·ªçc Linh', ' T√¢m T√¢m'];
            let forcedIndex = 0;

            //T·∫°o √¢m thanh v√† t·∫£i t·∫≠p tin tick.mp3.
            let audio = new Audio('tick.mp3');
            function playSound() {
                audio.pause();
                audio.currentTime = 0;
                audio.play();
            }
            
            //Hi·ªÉn th·ªã c√°c n√∫t v√≤ng quay
            function statusButton(status) {
                if ( status==1 ) { //tr∆∞·ªõc khi quay
                    document.getElementById('spin_start').removeAttribute("disabled");
                    document.getElementById('spin_reset').classList.add("hide");
                } else if ( status==2 ) { //ƒëang quay
                    document.getElementById('spin_start').setAttribute("disabled", false);
                    document.getElementById('spin_reset').classList.add("hide");
                } else if ( status==3 ) { //k·∫øt qu·∫£
                    document.getElementById('spin_reset').classList.remove("hide");
                } else {
                    alert('C√°c gi√° tr·ªã c·ªßa status: 1, 2, 3');
                }
            }
            statusButton(1);
            
            //stopAngle
         function stopAngle() {
    let stopAt;

    // üëâ N·∫øu c√≤n t√™n b·ªã √©p
    if (forcedIndex < forcedWinners.length) {
        const targetName = forcedWinners[forcedIndex].trim();

        // t√¨m segment t∆∞∆°ng ·ª©ng
        for (let i = 1; i < theWheel.segments.length; i++) {
            if (
                theWheel.segments[i] &&
                String(theWheel.segments[i].text).trim() === targetName
            ) {
                // t√≠nh g√≥c ƒë·ªÉ kim tr√∫ng segment n√†y
                stopAt = theWheel.getRandomForSegment(i);
                forcedIndex++;
                break;
            }
        }
    }

    // üëâ N·∫øu kh√¥ng √©p ƒë∆∞·ª£c (h·∫øt danh s√°ch ho·∫∑c kh√¥ng t√¨m th·∫•y)
    if (stopAt === undefined) {
        stopAt = Math.random() * 360;
    }

    theWheel.animation.stopAngle = stopAt;
}

            
            //startSpin
            function startSpin() {
                // Ensure that spinning can't be clicked again while already running.
                if (wheelSpinning == false) {
                    //CSS hi·ªÉn th·ªã button
                    statusButton(2);
                    
                    //ƒê·∫∑t k·∫øt qu·∫£ mong mu·ªën
                    stopAngle();
                    
                    //H√†m b·∫Øt ƒë·∫ßu quay
                    theWheel.startAnimation();

                    //Kh√≥a v√≤ng quay
                    wheelSpinning = true;
                }
            }
            
            // Rebuild the Winwheel from a plain segments array (skips index 0)
            function rebuildWheel(newSegments) {
                // preserve animation options
                const anim = theWheel.animation;
                const pins = theWheel.pins;
                const outerR = theWheel.outerRadius;
                const textSize = theWheel.textFontSize;

                // destroy existing wheel canvas by clearing and recreating Winwheel instance
                theWheel.stopAnimation(false);

                theWheel = new Winwheel({
                    'numSegments': newSegments.length,
                    'outerRadius': outerR,
                    'textFontSize': textSize,
                    'rotationAngle': 0,
                    'segments': newSegments,
                    'animation': {
                        'type'     : anim.type || 'spinToStop',
                        'duration' : anim.duration || duration,
                        'spins'    : anim.spins || spins,
                        'callbackSound'    : playSound,
                        'soundTrigger'     : 'pin',
                        'callbackFinished' : alertPrize
                    },
                    'pins': pins
                });
            }

            //Result
            function alertPrize(indicatedSegment) {
                alert(" M·ªùi b·∫°n : " + indicatedSegment.text);

                try {
                    // Build a new segments array excluding the winner
                    const current = theWheel.segments;
                    const newSegs = [];

                    // current[0] is undefined for Winwheel, so iterate from 1
                    for (let i = 1; i < current.length; i++) {
                        const s = current[i];
                        if (!s) continue;
                        if (String(s.text).trim() === String(indicatedSegment.text).trim()) {
                            // skip winner (remove it)
                            continue;
                        }
                        // keep segment (copy fillStyle and text)
                        newSegs.push({ fillStyle: s.fillStyle, text: s.text });
                    }

                    // If there are segments left, rebuild the wheel; otherwise disable spinning
                    if (newSegs.length > 0) {
                        rebuildWheel(newSegs);
                    } else {
                        // remove wheel visually and disable button
                        theWheel.stopAnimation(false);
                        document.getElementById('spin_start').setAttribute('disabled', 'true');
                        alert('ƒê√£ h·∫øt √¥ ƒë·ªÉ quay.');
                    }
                } catch (e) {
                    console.error('Error removing winning segment:', e);
                }

                //CSS hi·ªÉn th·ªã button
                statusButton(3);
            }

            //resetWheel
            function resetWheel() {
                //CSS hi·ªÉn th·ªã button
                statusButton(1);
                
                theWheel.stopAnimation(false);  // Stop the animation, false as param so does not call callback function.
                theWheel.rotationAngle = 0;     // Re-set the wheel angle to 0 degrees.
                theWheel.draw();                // Call draw to render changes to the wheel.

                wheelSpinning = false;          // Reset to false to power buttons and spin can be clicked again.
            }
        </script>
    </body>
</html>
